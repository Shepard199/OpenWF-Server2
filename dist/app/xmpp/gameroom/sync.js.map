{"version":3,"sources":["../../../../src/app/xmpp/gameroom/sync.js"],"names":["client","stz","query","getPlayers","obj","array","i","length","online_id","attrs","from","profile_id","team_id","status","observer","skill","nickname","clanName","class_id","group_id","presence","experience","rank","banner_badge","banner_mark","banner_stripe","region_id","gameroomopen","findOne","$elemMatch","err","res","setserver","parse","to","id","mission","mission_key","send","setserver2","setprivatestatus","room_id","room_type","core","teams_switched","room_name","private","players","team_balanced","min_ready_players","revision","Math","floor","Date","now","gettime","start_play","session_join_xml","sort","_id"],"mappings":"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","file":"sync.js","sourcesContent":["import Account from '../../modules/account/model';\nimport xmpp from 'node-xmpp-server';\nimport ltx from 'ltx';\n\nexport default (client, stz, query) => {\n\n\n    function getPlayers(obj){\n    \n        let array =  '';\n        for (var i = 0; i < obj.length; i++) {\n            if(obj[i].online_id === stz.attrs.from){\n                array += \"<player profile_id='\"+obj[i].profile_id+\"' team_id='\"+obj[i].team_id+\"' status='\"+obj[i].status+\"' observer='\"+obj[i].observer+\"' skill='\"+obj[i].skill+\"' nickname='\"+obj[i].nickname+\"' clanName='\"+obj[i].clanName+\"' class_id='\"+obj[i].class_id+\"' online_id='\"+obj[i].online_id+\"' group_id='\"+obj[i].group_id+\"' presence='\"+obj[i].presence+\"' experience='\"+obj[i].experience+\"' rank='\"+obj[i].rank+\"' banner_badge='\"+obj[i].banner_badge+\"' banner_mark='\"+obj[i].banner_mark+\"' banner_stripe='\"+obj[i].banner_stripe+\"' region_id='\"+obj[i].region_id+\"'/>\";\n            }else{\n                array += \"<player profile_id='\"+obj[i].profile_id+\"' team_id='\"+obj[i].team_id+\"' status='\"+obj[i].status+\"' observer='\"+obj[i].observer+\"' skill='\"+obj[i].skill+\"' nickname='\"+obj[i].nickname+\"' clanName='\"+obj[i].clanName+\"' class_id='\"+obj[i].class_id+\"' online_id='\"+obj[i].online_id+\"' group_id='\"+obj[i].group_id+\"' presence='\"+obj[i].presence+\"' experience='\"+obj[i].experience+\"' rank='\"+obj[i].rank+\"' banner_badge='\"+obj[i].banner_badge+\"' banner_mark='\"+obj[i].banner_mark+\"' banner_stripe='\"+obj[i].banner_stripe+\"' region_id='\"+obj[i].region_id+\"'/>\";\n            }\n        }\n        return array;\n\n    }\n\n    Account.gameroomopen.findOne({'core.players': {$elemMatch: {online_id: stz.attrs.from}}}, function(err, res) {\n\n\n        let setserver = ltx.parse(\n            \"<iq to='\"+stz.attrs.from+\"' from='\"+stz.attrs.to+\"' id='\"+stz.attrs.id+\"' type='get'>\"+\n                \"<query xmlns='urn:cryonline:k01'>\"+\n                    \"<setserver host='gameamazing' mission_key='\"+res.mission.mission_key+\"' node='http://camaya.net/gloox' ver='0RyJmsC2EQAjYmYlhkMGaVEgE/8=' version='' session_id='1' cpu_usage='0' mode='pvp_pve' port='60018' status='2' build_type='--release' region_id='global' memory_usage='836' />\"+\n                \"</query>\"+\n            \"</iq>\"\n        )\n\n        client.send(setserver)\n\n\n        let setserver2 = ltx.parse(\n            \"<iq to='\"+stz.attrs.from+\"' from='\"+stz.attrs.to+\"' id='\"+stz.attrs.id+\"' type='get'>\"+\n                \"<query xmlns='urn:cryonline:k01'>\"+\n                    \"<setserver master_node='192.168.25.3' />\"+\n                \"</query>\"+\n            \"</iq>\"\n        )\n\n        client.send(setserver2)\n        \n        let setprivatestatus = ltx.parse(\n            \"<iq to='\"+stz.attrs.from+\"' from='\"+stz.attrs.to+\"' id='\"+stz.attrs.id+\"' type='get'>\"+\n                \"<query xmlns='urn:cryonline:k01'>\"+\n                    \"<gameroom_sync bcast_receivers='rubens@warface/GameClient'>\"+\n                        \"<game_room room_id='\"+res.room_id+\"' room_type='\"+res.room_type+\"'>\"+\n                            \n                            \"<core teams_switched='\"+res.core.teams_switched+\"' room_name='\"+res.core.room_name+\"' private='\"+query.private+\"' players='\"+res.core.players+\"' can_start='1' team_balanced='\"+res.core.team_balanced+\"' min_ready_players='\"+res.core.min_ready_players+\"' revision='\"+res.core.revision+\"'>\"+\n                                \"<players>\"+\n                                    getPlayers(res.core.players)+\n                                \"</players>\"+\n                                \"<playersReserved/>\"+\n                            \"</core>\"+\n                            \n                            \"<session id='823427570887578502' status='2' game_progress='1' start_time='\"+Math.floor(Date.now() / 1000)+\"' revision='130'/>\"+\n                            \n                            \"<custom_params friendly_fire='0' enemy_outlines='1' auto_team_balance='0' dead_can_chat='1' join_in_the_process='1' max_players='5' round_limit='0' class_restriction='253' inventory_slot='2113929215' revision='13'/>\"+\n                            \n                            \"<mission mission_key='\"+res.mission.mission_key+\"' no_teams='1' name='@na_mission_path01_1' setting='africa/africa_base' mode='pve' mode_name='@PvE_game_mode_desc' mode_icon='pve_icon' description='@mission_desc_africa_path' image='mapImgAfrica_training' difficulty='easy' type='trainingmission' time_of_day='9:06' revision='13'>\"+\n                            \"<objectives factor='1'>\"+\n                                \"<objective id='0' type='primary'/>\"+\n                                \"<objective id='11' type='secondary'/>\"+\n                                \"<objective id='15' type='secondary'/>\"+\n                            \"</objectives>\"+\n                            \"</mission>\"+\n\n                        \"</game_room>\"+\n                    \"</gameroom_sync>\"+\n                \"</query>\"+\n            \"</iq>\")\n        client.send(setprivatestatus)\n\n       // console.log(setprivatestatus.toString());\n\n        let gettime = Math.floor(Date.now() / 100);\n\n        let start_play = ltx.parse(\n            \"<iq to='\"+stz.attrs.from+\"' from='\"+stz.attrs.to+\"' id='\"+stz.attrs.id+\"' type='get'>\"+\n                \"<query xmlns='urn:cryonline:k01'>\"+\n                    \"<mission_update>\"+\n                        \"<game_room room_id='\"+res.room_id+\"' room_type='\"+res.room_type+\"'>\"+\n                            \"<session start_time='\"+gettime+\"' id='823427570887578502' status='2' game_progress='1' revision='367' />\"+\n                        \"</game_room>\"+\n                    \"</mission_update>\"+\n                \"</query>\"+\n            \"</iq>\"\n        )\n\n        client.send(start_play)\n\n\n\n        let session_join_xml = ltx.parse(\n            \"<iq to='\"+stz.attrs.from+\"' from='\"+stz.attrs.to+\"' id='\"+stz.attrs.id+\"' type='get'>\"+\n                \"<query xmlns='urn:cryonline:k01'>\"+\n                    //\"<session_join room_id='\"+res.room_id+\"' server='gameamazing' hostname='179.179.165.163' port='64203' local='0'/>\"+\n                    \"<session_join server='gameamazing' hostname='192.168.25.3' port='60016' local='0'/>\"+\n                \"</query>\"+\n            \"</iq>\")\n        client.send(session_join_xml)\n\n\n    }).sort({_id:1});\n}"]}